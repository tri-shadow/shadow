# 共识算法

* 我们提出的 DPoA 是一套区块链的出块流程。原理如下：全网的所有节点中，会有一部分机器被选拔为出块节点或候选节点，构成一个大的出块节点联盟，负责区块链的记账，这个联盟的成员按照规则在不断的变化，以保证相对的随机性与公平性。*

## 我们将网络中的节点分成三类：
1. 出块节点：负责网络上的记账工作。
2. 候选节点：不负责网络上的记账工作，但是随时准备变成出块节点，进行网络记账。
3. 普通节点：网络上的其它节点，只是单纯的同步区块的信息。可以申请成为出块节点。

## 在概念层面，有几个问题需要明确：
### 1. 什么是出块节点联盟
>出块节点联盟包含两类节点。一类节点负责当前网络的记账，我们称这类节点为出块节点，出块节点的数量是固定的， 不会轻易被调整。一类节点不负责当前网络的记账，但是它们作为出块节点的候选节点，随时准备好变成出块节点，服务于网络记账，我们称这类节点为候选节点。

### 2. 节点联盟是如何产生的？
>我们的区块链诞生的时候，会有一个创世出块节点的列表，它随区块链的诞生而产生，负责形成最初的出块节点联盟（一个被初始化的出块节点列表，和一个空的候选节点列表）。
		
### 3. 节点联盟是如何变化的？
>网络上的每一个普通全节点都有资格申请成为一个出块节点。但是，由于申请时的出块节点联盟的状态不同，导致节点被提名成出块节点的流程略有不同：		

* 当出块节点总数小于极限值时：普通节点发出申请，可以被现有的出块节点提名，直接进入出块节点列表。
* 当出块节点总数等于极限值时：普通节点发出申请，可以被现有的出块节点提名，放入候选节点的列表，等待轮换参与出块。

### 4. 联盟列表的更新频率
>普通的节点在每个出块周期（14-16秒）内，都有机会被出块节点选入到联盟列表中。如果出块节点列表有空位，则新节点进入出块节点列表中，参与下一轮的出块。
如果出块节点列表已经没有空位，则新节点进入候选节点列表中，等待空位。
每隔24小时会自动重整一次候选节点列表，确保列表中节点的出块意愿不会因为时间而消殆。

### 5. 出块节点联盟需要遵守什么样的规则？
* 出块节点必须保证连续正确的为网络出块，如果不能正常出块（不出块，出错块）就会被从出块节点中剔除，会有一个候选节点来替代它。
* 一个节点不能正常出块，系统会将其判断成不合格节点，将其放入黑名单中，进入黑名单的机器，在24小时之内不能重复申请成为出块节点。

* 具体规则分以下几种情况：
    1.  __出块节点列表未满__

        每个节点有3次出错的机会，每错出或漏出一个块减1次，到0时被放入黑名单，并且在当前 epoch 不再被选拔

    1. __出块节点列表已满，候选节点列表小于出块节点列表__

        此时主要工作是选拔候选节点，为每个被选拔的节点设置 weight = 5，
        出块规则与 “出块节点列表未满” 时的规则相同

    1. __出块节点列表已满，候选节点列表大于出块节点列表__

        在这个规则生效时，出块节点将不再拥有三次出错机会，
        此时的规则是每出一轮出块就要替换掉全部的出块节点，
        从候选节点列表中按 weight 随机提拔一批新出块节点到出块节点列表，
        将原出块节点列表移入候选节点列表，并将 weight - 1，
        当 weight == 0 时则移入黑名单，等待下一个 epoch
        假设出块节点列表最大长度 12 ，候选节点列表最大长度与 epoch 相等。每一轮出块，指的就是每 12 个块，每笔交易的确认时间也是 12 块，但是对于交易所来说最好是经过 24 个块才确认一笔交易。

    > 规则可以保证只要被提名到候选节点，就一定有机会参与出块

### 6. 节点联盟是如何应对错误的场景？

_错误场景一：负责出块的节点不能正常出块_
>如果在一个时间槽内，负责出块的节点不能正常出块，列表中的其他节点会按照自己的记账进行出块，来弥补这个时间槽的缺失。

_错误场景二：节点接收到一个错误的块_
>如果再节点收到一个新挖出的区块，但是parent与主分支上的不一致，节点将会保存该区块，但是并不切换主分支

_错误场景三：节点收到多个错误块，parent都是主分支上最新的一个区块_
>如果多个区块中不包含预定节点的区块，则记录全部的区块，并将主链切换到时间最早的区块上如果多个区块中包含预定节点的区块，则记录全部的区块，并将主链切换到预定节点的区块上

### 7. TODO 发行总量与矿工的奖励

> 发行总量将被限制在 X ，矿工份额 Y%